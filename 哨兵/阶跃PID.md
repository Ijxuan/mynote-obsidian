阶跃PID，是在双环PID参数整定的过程中用到的一种方法

先看双环PID

直接控制电机的内环
速度环是内环，角度环是外环

控制流程如下：
读取电机当前的角度和速度

当前角度和目标角度   进行PID运算   输出一个速度目标值

当前速度和目标速度  进行PID运算    输出一个控制电压/电流

电调根据接收控制电压/电流，根据这个值控制电机，然后又将电机的速度和角度值反馈给单片机

说回阶跃调PID，阶跃是目标角度的阶跃，具体表现为一般需要让电机转2圈左右
阶跃，阶跃，是目标角度的阶跃，目标角度阶跃的一瞬间，目标速度也会跟着阶跃，然后到目标角度附近时，目标速度也会很小，就是一个越接近目标，速度目标值就越小

看下图青色线，是目标速度曲线
灰色是反馈回来的速度值
![[1.png]]
可以看到目标速度突变到最大值再慢慢下降
但是真实速度始终没有达到最大速度
这个时候就可以引入第一个需要调整的值了：阶跃多少？
==一：高速响应与高速保持==
之前说的是让电机转2圈左右，那么根据实际表现，目标速度维持在最大速度的区间太短了，增大阶跃，让目标角度从0突变到20000变成从0突变到30000
调整后，应该要做到：
![[2.png]]
这个时候发现越是接近目标速度，速度增长越慢，给人一种无力的感觉
这时候可以去看看速度环的输出：
![[3.png]]
浅绿色是总输出，总输出=P_OUT+I_OUT+D_OUT
瞬间拉满到极限28000，但是当速度误差减小时就开始往下掉

红色的的线是P_OUT当速度误差减小时，P_OUT也跟着减小，这时候总输出就无法时刻保持28000的输出了

解决思路：
让P_OUT更大，也就是增大系数Kp
或者增大I_OUT的最大值，也就是增大系数Ki或者增大积分分离的值
反正就是让系数Ki乘以积分分离的值，等于28000

==二：减速跟随==

![[2.png]]
还是用这幅图，可以看到在x轴坐标1039-1139这一段没有贴紧，延迟响应导致超调，
那么到底是青色的线下降时斜率太大了还是灰色的线下降时斜率太小了？

从两种情况考虑

到底是哪一种情况？：可以搞清楚，看另一条曲线，速度环的输出曲线
![[4.png]]
![[5.png]]
可以看到在2283这一时刻开始就已经反向输出拉满-28000，即电机已经尽最大努力刹车了，但是仍然刹不住车，
所以不是灰色的线（真实速度）下降时斜率太小了
而是青色的线（目标速度）下降时斜率太大

这个时候就可以引入第二个需要调整的值了：

外环的Kp值，外环的系数给的大，青色的线（目标速度）就越陡峭
外环的系数给的小，青色的线（目标速度）就越平缓，

因为阶跃的总角度是一定的，下降阶段长了，那么高速响应与高速保持阶段就会相应的变短：
![[6.png]]
可以看到，同一套内环参数的情况下，青色的线（目标速度）变得平缓后，
灰色的线（真实速度）很轻易地就紧紧的贴合了，然后连同因为响应不及时导致地震荡也消除了，
这么简单就完美了？不用自欺欺人
这说明外环的Kp值给的太小了青色的线（目标速度）过于平缓，需要在增大一点
需要一点点试出来

还有
这副图中，目标速度不等当前速度追上了就开始减小了，
所以不要忘了回过头去重新确定阶跃多少角度

-----

前期的准备工作做完了，就可以正式开始调参了：

多思考每一条曲线的含义，
多找一些关键时间点，

尽可能打印出更多更细值的曲线，增加观测手段，不要嫌麻烦，
比如把总输出分成四个变量分析：
总输出=P_OUT+I_OUT+D_OUT
同一时刻，切换不同曲线去分析，我就一口气打印出十个变量，
经常观测的变量有7个：
哪七个：
实时观测的目标速度与当前速度，保证不出问题（事故）
暂停后分析速度环是怎么变化的，有没有异常波动
有异常在切换到P_OUT，I_OUT，D_OUT三条线具体分析
对应的去更改Kp，Ki，Kd三条曲线

确定曲线的因果关系就知道该调整哪一个系数了。。。

![[2.1.png]]

![[2.2.png]]

![[2.3.png]]







